"use strict";(self.webpackChunknxdb=self.webpackChunknxdb||[]).push([[1500],{8306:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>g,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var t=a(4848),r=a(8453);const i={title:"Migration Storage",slug:"migration-storage.html"},o="Storage Migration",s={id:"migration-storage",title:"Migration Storage",description:"The storage migration plugin can be used to migrate all data from one existing RxStorage into another. This is useful when:",source:"@site/docs/migration-storage.md",sourceDirName:".",slug:"/migration-storage.html",permalink:"/migration-storage.html",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Migration Storage",slug:"migration-storage.html"},sidebar:"tutorialSidebar",previous:{title:"Migration Schema",permalink:"/migration-schema.html"},next:{title:"Schema Validation",permalink:"/schema-validation.html"}},l={},d=[{value:"Usage",id:"usage",level:2},{value:"Migrate from a previous NxDB major version",id:"migrate-from-a-previous-nxdb-major-version",level:2},{value:"Disable Version Check on NxDB Premium \ud83d\udc51",id:"disable-version-check-on-nxdb-premium-",level:2}];function m(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"storage-migration",children:"Storage Migration"}),"\n",(0,t.jsx)(n.p,{children:"The storage migration plugin can be used to migrate all data from one existing RxStorage into another. This is useful when:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["You want to migration from one ",(0,t.jsx)(n.a,{href:"/rx-storage.html",children:"RxStorage"})," to another one."]}),"\n",(0,t.jsx)(n.li,{children:"You want to migrate to a new major NxDB version while keeping the previous saved data. This function only works from the previous major version upwards. Do not use it to migrate like nxdb v9 to v14."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The storage migration ",(0,t.jsx)(n.strong,{children:"drops deleted documents"})," and filters them out during the migration."]}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsxs)(n.p,{children:["Lets say you want to migrate from LokiJs to the ",(0,t.jsx)(n.a,{href:"/rx-storage-dexie.html",children:"Dexie.js"})," RxStorage."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"import { migrateStorage } from 'nxdb/plugins/migration-storage';\nimport {\n    getRxStorageLoki\n} from 'nxdb/plugins/storage-loki';\nimport { getRxStorageDexie } from 'nxdb/plugins/storage-dexie';\n\n// create the new RxDatabase\nconst db = await createRxDatabase({\n    name: dbLocation,\n    storage: getRxStorageDexie(),\n    multiInstance: false\n});\n\nawait migrateStorage({\n    database: db as any,\n    /**\n     * Name of the old database,\n     * using the storage migration requires that the\n     * new database has a different name.\n     */\n    oldDatabaseName: 'myOldDatabaseName',\n    oldStorage: getRxStorageLoki(), // RxStorage of the old database\n    batchSize: 500, // batch size\n    parallel: false, // <- true if it should migrate all collections in parallel. False (default) if should migrate in serial\n    afterMigrateBatch: (input: AfterMigrateBatchHandlerInput) => {\n        console.log('storage migration: batch processed');\n    }\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"migrate-from-a-previous-nxdb-major-version",children:"Migrate from a previous NxDB major version"}),"\n",(0,t.jsxs)(n.p,{children:["To migrate from a previous NxDB major version, you have to install the 'old' NxDB in the ",(0,t.jsx)(n.code,{children:"package.json"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n    "dependencies": {\n        "nxdb-old": "npm:nxdb@14.17.1",\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"The you can run the migration by providing the old storage:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"/* ... */\nimport { migrateStorage } from 'nxdb/plugins/migration-storage';\nimport {\n    getRxStorageLoki\n} from 'nxdb-old/plugins/storage-loki'; // <- import from the old NxDB version\n\nawait migrateStorage({\n    database: db as any,\n    /**\n     * Name of the old database,\n     * using the storage migration requires that the\n     * new database has a different name.\n     */\n    oldDatabaseName: 'myOldDatabaseName',\n    oldStorage: getRxStorageLoki(), // RxStorage of the old database\n    batchSize: 500, // batch size\n    parallel: false,\n    afterMigrateBatch: (input: AfterMigrateBatchHandlerInput) => {\n        console.log('storage migration: batch processed');\n    }\n});\n/* ... */\n"})}),"\n",(0,t.jsxs)(n.h2,{id:"disable-version-check-on-nxdb-premium-",children:["Disable Version Check on ",(0,t.jsx)(n.a,{href:"/premium",children:"NxDB Premium \ud83d\udc51"})]}),"\n",(0,t.jsxs)(n.p,{children:["RxDb Premium has a check in place that ensures that you do not accidentally use the wrong NxDB core and \ud83d\udc51 Premium version together which could break your database state.\nThis can be a problem during migrations where you have multiple versions of NxDB in use and it will throw the error ",(0,t.jsx)(n.code,{children:"Version mismatch detected"}),".\nYou can disable that check by importing and running the ",(0,t.jsx)(n.code,{children:"disableVersionCheck()"})," function from NxDB Premium."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// NxDB Premium v15 or newer:\nimport {\n    disableVersionCheck\n} from 'nxdb-premium-old/plugins/shared';\ndisableVersionCheck();\n\n\n// NxDB Premium v14:\n\n// for esm\nimport {\n    disableVersionCheck\n} from 'nxdb-premium-old/dist/es/shared/version-check.js';\ndisableVersionCheck();\n\n// for cjs\nimport {\n    disableVersionCheck\n} from 'nxdb-premium-old/dist/lib/shared/version-check.js';\ndisableVersionCheck();\n\n\n\n\n"})})]})}function g(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(m,{...e})}):m(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>s});var t=a(6540);const r={},i=t.createContext(r);function o(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);